% @author: Scott Campit
function [fixedModel] = testMetabolicModel(model)
    closedModel = model;
    
    exchange_rxns = strmatch('EX_', closedModel.rxns);
    demand_rxns = strmatch('DM_', closedModel.rxns);
    
    rxns_to_test = unique([exchange_rxns; demand_rxns; selExc]);
    
    cnt = 1;
    tol = 1E-6;
    
    % TEST 1: Perform leak tests for exchanged metabolites
    selExc = (find(full((sum(abs(modelClosed.S) == 1, 1) == 1) & ...
        (sum(modelClosed.S ~= 0) == 1))))';
    [LeakRxns, modelTested, LeakRxnsFluxVector] = ...
        fastLeakTest(closedModel, closedModel.rxns(selExc),'false');
    
    TableChecks{cnt,1} = 'fastLeakTest 1';
    if length(LeakRxns) > 0
        warning('model leaks metabolites!')
        TableChecks{cnt, 2} = 'Model leaks metabolites!';
    else
        TableChecks{cnt, 2} = 'Leak free!';
    end
    cnt = cnt + 1;
    
    % TEST 2: Perform leak tests for demand reactions
    [LeakRxnsDM, modelTestedDM, LeakRxnsFluxVectorDM] = ...
        fastLeakTest(closedModel, closedModel.rxns(selExc), 'true');
    TableChecks{cnt,1} = 'fastLeakTest 2 - add demand reactions for each metabolite in the model';

    if length(LeakRxnsDM)>0
        TableChecks{cnt,2} = 'Model leaks metabolites when demand reactions are added!';
    else
        TableChecks{cnt,2} = 'Leak free when demand reactions are added!';
    end
    cnt = cnt + 1;
    
    % TEST 3: Compute ATP Yield
    TableChecks{cnt, 1} = 'Compute ATP yield';
    if 1 % test ATP yield
        [Table_csources, TestedRxns, Perc] = testATPYieldFromCsources(model);
        TableChecks{cnt,2} = 'Done. See variable Table_csources for results.';
    else
        TableChecks{cnt,2} = 'Not performed.';
    end
    cnt = cnt + 1;
    
    % TEST4: Check for duplicated reactions
    TableChecks{cnt,1} = 'Check duplicated reactions';

    method='FR';

    removeFlag=0;

    [modelOut,removedRxnInd, keptRxnInd] = checkDuplicateRxn(model,method,removeFlag,0);

    if isempty(removedRxnInd)

    TableChecks{cnt,2} = 'No duplicated reactions in model.';

    else

    TableChecks{cnt,2} = 'Duplicated reactions in model.';

    end

    cnt = cnt + 1;
    
    end